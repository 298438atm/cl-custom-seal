<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>印章生成器</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 420px;
      gap: 24px;
      align-items: start;
    }

    @media (max-width: 1024px) {
      .container {
        grid-template-columns: 1fr;
      }
    }

    .header {
      grid-column: 1 / -1;
      text-align: center;
      padding: 20px 0;
    }

    .header h1 {
      color: #fff;
      font-size: 2rem;
      font-weight: 600;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      margin-bottom: 8px;
    }

    .header p {
      color: rgba(255, 255, 255, 0.8);
      font-size: 0.95rem;
    }

    /* 控制面板 */
    .control-panel {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
      overflow: hidden;
    }

    .card {
      border-bottom: 1px solid #eee;
    }

    .card:last-child {
      border-bottom: none;
    }

    .card-header {
      padding: 16px 20px;
      background: linear-gradient(to right, #f8f9fa, #fff);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      user-select: none;
      transition: background 0.2s;
    }

    .card-header:hover {
      background: linear-gradient(to right, #f0f1f3, #f8f9fa);
    }

    .card-header h3 {
      font-size: 0.95rem;
      font-weight: 600;
      color: #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-header h3::before {
      content: "";
      width: 4px;
      height: 18px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 2px;
    }

    .card-header .toggle-icon {
      font-size: 0.8rem;
      color: #999;
      transition: transform 0.3s;
    }

    .card.collapsed .toggle-icon {
      transform: rotate(-90deg);
    }

    .card.collapsed .card-body {
      display: none;
    }

    .card-body {
      padding: 20px;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }

    .form-row:last-child {
      margin-bottom: 0;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    .form-group label {
      font-size: 0.85rem;
      font-weight: 500;
      color: #555;
    }

    .form-group input[type="text"],
    .form-group input[type="number"],
    .form-group select {
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 0.9rem;
      transition: all 0.2s;
      background: #f8f9fa;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
      background: #fff;
    }

    .form-group input[type="color"] {
      width: 100%;
      height: 40px;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 4px;
      cursor: pointer;
      background: #f8f9fa;
    }

    .form-group input[type="color"]::-webkit-color-swatch-wrapper {
      padding: 0;
    }

    .form-group input[type="color"]::-webkit-color-swatch {
      border: none;
      border-radius: 4px;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 0;
    }

    .checkbox-group input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: #667eea;
      cursor: pointer;
    }

    .checkbox-group label {
      font-size: 0.9rem;
      color: #333;
      cursor: pointer;
    }

    /* 预览区域 */
    .preview-panel {
      position: sticky;
      top: 20px;
    }

    .preview-card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
      overflow: hidden;
    }

    .preview-header {
      padding: 16px 20px;
      background: linear-gradient(to right, #f8f9fa, #fff);
      border-bottom: 1px solid #eee;
    }

    .preview-header h3 {
      font-size: 0.95rem;
      font-weight: 600;
      color: #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .preview-header h3::before {
      content: "";
      width: 4px;
      height: 18px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 2px;
    }

    .canvas-wrapper {
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      background: repeating-conic-gradient(#f0f0f0 0% 25%, #fff 0% 50%) 50%/16px 16px;
    }

    canvas {
      display: block;
      border-radius: 8px;
    }

    /* 按钮组 */
    .button-group {
      padding: 16px 20px;
      background: #f8f9fa;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .btn {
      padding: 8px 10px;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.35);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.45);
    }

    .btn-secondary {
      background: #fff;
      color: #555;
      border: 1px solid #ddd;
    }

    .btn-secondary:hover {
      background: #f0f1f3;
      border-color: #ccc;
    }

    .btn-effect {
      background: linear-gradient(135deg, #f093fb, #f5576c);
      color: #fff;
    }

    .btn-effect:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(245, 87, 108, 0.35);
    }

    .btn-success {
      background: linear-gradient(135deg, #11998e, #38ef7d);
      color: #fff;
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(56, 239, 125, 0.35);
    }

    .button-divider {
      width: 1px;
      background: #ddd;
      margin: 0 5px;
    }

    /* 特效按钮组 */
    .effect-buttons {
      padding: 12px 20px;
      background: linear-gradient(to right, #fff5f5, #fff);
      border-top: 1px solid #fee;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .effect-label {
      font-size: 0.85rem;
      color: #888;
      margin-right: 8px;
    }

    .btn-sm {
      padding: 8px 14px;
      font-size: 0.85rem;
    }

    /* 弹窗样式 */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal {
      background: #fff;
      padding: 24px;
      border-radius: 16px;
      width: 90%;
      max-width: 450px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: modalIn 0.3s ease;
    }

    @keyframes modalIn {
      from {
        opacity: 0;
        transform: scale(0.9) translateY(20px);
      }

      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .modal h3 {
      font-size: 1.1rem;
      color: #333;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .modal h3::before {
      content: "";
      width: 4px;
      height: 20px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 2px;
    }

    .modal textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-family: "Consolas", "Monaco", monospace;
      font-size: 0.85rem;
      resize: vertical;
      min-height: 200px;
      background: #f8f9fa;
    }

    .modal textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 16px;
      justify-content: flex-end;
    }

    /* Toast 提示 */
    .toast {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      background: linear-gradient(135deg, #333, #1a1a1a);
      color: #fff;
      padding: 14px 28px;
      border-radius: 12px;
      font-size: 0.95rem;
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      z-index: 9999;
      pointer-events: none;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    .toast.show {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }

    /* 实时预览提示 */
    .live-preview-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.75rem;
      color: #38ef7d;
      background: rgba(56, 239, 125, 0.1);
      padding: 4px 10px;
      border-radius: 20px;
      margin-left: auto;
    }

    .live-preview-badge::before {
      content: "";
      width: 6px;
      height: 6px;
      background: #38ef7d;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.4;
      }
    }

    /* ========== 响应式适配 ========== */

    /* 平板适配 */
    @media (max-width: 1024px) {
      .container {
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .preview-panel {
        position: relative;
        top: 0;
        order: -1;
      }

      .header {
        padding: 16px 0;
      }
    }

    /* 移动端适配 */
    @media (max-width: 640px) {
      body {
        padding: 12px;
        background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
        background-attachment: fixed;
      }

      .container {
        gap: 12px;
      }

      .header {
        padding: 12px 0;
      }

      .header h1 {
        font-size: 1.5rem;
      }

      .header p {
        font-size: 0.85rem;
      }

      /* 控制面板移动端 */
      .control-panel {
        border-radius: 12px;
      }

      .card-header {
        padding: 14px 16px;
      }

      .card-header h3 {
        font-size: 0.9rem;
      }

      .card-header h3::before {
        width: 3px;
        height: 16px;
      }

      .card-body {
        padding: 16px;
      }

      .form-row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 12px;
      }

      .form-group {
        flex: 1 1 calc(50% - 6px);
        min-width: calc(50% - 6px);
        max-width: 100%;
      }

      .form-group.full-width {
        flex: 1 1 100%;
        min-width: 100%;
      }

      .form-group label {
        font-size: 0.8rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .form-group input[type="text"],
      .form-group input[type="number"],
      .form-group select {
        padding: 10px;
        font-size: 16px; /* 防止iOS自动缩放 */
        border-radius: 6px;
        width: 100%;
        min-width: 0;
        box-sizing: border-box;
      }

      .form-group input[type="color"] {
        height: 44px;
        width: 100%;
      }

      .checkbox-group {
        padding: 8px 0;
      }

      .checkbox-group input[type="checkbox"] {
        width: 22px;
        height: 22px;
      }

      .checkbox-group label {
        font-size: 0.85rem;
      }

      /* 预览区移动端 */
      .preview-card {
        border-radius: 12px;
      }

      .preview-header {
        padding: 12px 16px;
      }

      .preview-header h3 {
        font-size: 0.9rem;
      }

      .preview-header h3::before {
        width: 3px;
        height: 16px;
      }

      .live-preview-badge {
        font-size: 0.7rem;
        padding: 3px 8px;
      }

      .canvas-wrapper {
        padding: 16px;
        overflow-x: auto;
      }

      /* Canvas 自适应 */
      #sealCanvas {
        max-width: 100%;
        height: auto;
      }

      /* 按钮组移动端 */
      .effect-buttons {
        padding: 12px 16px;
        gap: 8px;
      }

      .effect-label {
        width: 100%;
        margin-bottom: 4px;
        font-size: 0.8rem;
      }

      .button-group {
        padding: 12px 16px;
        gap: 8px;
      }

      .btn {
        padding: 10px 14px;
        font-size: 0.85rem;
        flex: 1 1 calc(50% - 4px);
        justify-content: center;
        min-height: 44px;
        /* 触摸友好 */
      }

      .btn-sm {
        padding: 10px 12px;
        flex: 1 1 auto;
      }

      .button-divider {
        display: none;
      }

      /* 弹窗移动端 */
      .modal {
        width: 95%;
        padding: 20px;
        border-radius: 12px;
        max-height: 90vh;
        overflow-y: auto;
      }

      .modal h3 {
        font-size: 1rem;
      }

      .modal textarea {
        font-size: 14px;
        min-height: 150px;
      }

      .modal-buttons {
        flex-direction: column;
      }

      .modal-buttons .btn {
        flex: none;
        width: 100%;
      }

      /* Toast 移动端 */
      .toast {
        padding: 12px 20px;
        font-size: 0.9rem;
        max-width: 90%;
      }
    }

    /* 超小屏幕适配 */
    @media (max-width: 380px) {
      body {
        padding: 8px;
      }

      .header h1 {
        font-size: 1.3rem;
      }

      .form-group {
        flex: 1 1 100%;
        min-width: 100%;
      }

      .btn {
        flex: 1 1 100%;
      }

      .btn-sm {
        flex: 1 1 calc(50% - 4px);
      }
    }

    /* 横屏模式优化 */
    @media (max-height: 500px) and (orientation: landscape) {
      .header {
        padding: 8px 0;
      }

      .header h1 {
        font-size: 1.2rem;
        margin-bottom: 4px;
      }

      .header p {
        display: none;
      }

      .canvas-wrapper {
        padding: 12px;
      }
    }

    /* 触摸设备优化 */
    @media (hover: none) and (pointer: coarse) {
      .btn:hover {
        transform: none;
        box-shadow: none;
      }

      .btn:active {
        transform: scale(0.98);
        opacity: 0.9;
      }

      .btn-primary:active {
        box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
      }

      .btn-effect:active {
        box-shadow: 0 2px 10px rgba(245, 87, 108, 0.3);
      }

      .btn-success:active {
        box-shadow: 0 2px 10px rgba(56, 239, 125, 0.3);
      }

      .card-header:hover {
        background: linear-gradient(to right, #f8f9fa, #fff);
      }

      .card-header:active {
        background: linear-gradient(to right, #f0f1f3, #f8f9fa);
      }
    }
  </style>
</head>

<body>

  <div class="container">
    <header class="header">
      <h1>印章生成器</h1>
      <p>自定义设计专属印章，支持多种样式和做旧效果</p>
    </header>

    <!-- 控制面板 -->
    <div class="control-panel">
      <!-- 基础设置 -->
      <div class="card">
        <div class="card-header" onclick="toggleCard(this)">
          <h3>基础设置</h3>
          <span class="toggle-icon">▼</span>
        </div>
        <div class="card-body">
          <div class="form-row">
            <div class="form-group full-width">
              <label>印章文字</label>
              <input type="text" id="sealText" value="什么什么有限公司">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>字体大小</label>
              <input id="fontSize" type="number" value="48">
            </div>
            <div class="form-group">
              <label>文字半径</label>
              <input id="textRadius" type="number" value="120">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>字体粗细</label>
              <select id="fontWeight">
                <option value="normal">正常</option>
                <option value="bold" selected>加粗</option>
                <option value="bolder">更粗</option>
                <option value="lighter">更细</option>
                <option value="100">100</option>
                <option value="200">200</option>
                <option value="300">300</option>
                <option value="400">400</option>
                <option value="500">500</option>
                <option value="600">600</option>
                <option value="700">700</option>
                <option value="800">800</option>
                <option value="900">900</option>
              </select>
            </div>
            <div class="form-group">
              <label>字体类型</label>
              <select id="fontFamily">
                <option value="SimSun" selected>宋体</option>
                <option value="SimHei">黑体</option>
                <option value="KaiTi">楷体</option>
                <option value="FangSong">仿宋</option>
                <option value="Microsoft YaHei">微软雅黑</option>
                <option value="STSong">华文宋体</option>
                <option value="STHeiti">华文黑体</option>
                <option value="STKaiti">华文楷体</option>
                <option value="STFangsong">华文仿宋</option>
                <option value="PingFang SC">苹方</option>
                <option value="Hiragino Sans GB">冬青黑体</option>
                <option value="Noto Sans SC">思源黑体</option>
                <option value="Noto Serif SC">思源宋体</option>
                <option value="Arial">Arial</option>
                <option value="Times New Roman">Times New Roman</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>文字颜色</label>
              <input id="fontColor" type="color" value="#ff0000">
            </div>
            <div class="form-group">
              <label>起始角度</label>
              <input id="startDeg" type="number" value="170">
            </div>
            <div class="form-group">
              <label>结束角度</label>
              <input id="endDeg" type="number" value="360">
            </div>
          </div>
        </div>
      </div>

      <!-- 中心图案 -->
      <div class="card">
        <div class="card-header" onclick="toggleCard(this)">
          <h3>中心图案</h3>
          <span class="toggle-icon">▼</span>
        </div>
        <div class="card-body">
          <div class="form-row">
            <div class="form-group">
              <label>中心图案</label>
              <input type="text" id="centerChar" value="★">
            </div>
            <div class="form-group">
              <label>图案大小</label>
              <input id="starSize" type="number" value="130">
            </div>
          </div>
        </div>
      </div>

      <!-- 外圈设置 -->
      <div class="card">
        <div class="card-header" onclick="toggleCard(this)">
          <h3>外圈设置</h3>
          <span class="toggle-icon">▼</span>
        </div>
        <div class="card-body">
          <div class="form-row">
            <div class="form-group">
              <label>圆线宽度</label>
              <input id="circleWidth" type="number" value="10">
            </div>
            <div class="form-group">
              <label>圆线颜色</label>
              <input id="circleColor" type="color" value="#ff0000">
            </div>
          </div>
        </div>
      </div>

      <!-- 下方弧形小字 -->
      <div class="card">
        <div class="card-header" onclick="toggleCard(this)">
          <h3>下方弧形小字</h3>
          <span class="toggle-icon">▼</span>
        </div>
        <div class="card-body">
          <div class="checkbox-group">
            <input type="checkbox" id="enableSmallText" checked>
            <label for="enableSmallText">启用下方弧形小字</label>
          </div>
          <div class="form-row">
            <div class="form-group full-width">
              <label>小字内容</label>
              <input type="text" id="smallText" value="123456789">
            </div>
          </div>
        </div>
      </div>

      <!-- 水平文字 -->
      <div class="card">
        <div class="card-header" onclick="toggleCard(this)">
          <h3>水平文字</h3>
          <span class="toggle-icon">▼</span>
        </div>
        <div class="card-body">
          <div class="checkbox-group">
            <input type="checkbox" id="enableHorizontalText">
            <label for="enableHorizontalText">启用水平文字</label>
          </div>
          <div class="form-row">
            <div class="form-group full-width">
              <label>水平文字内容</label>
              <input type="text" id="horizontalText" value="水平文字">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>文字大小</label>
              <input id="horizontalTextSize" type="number" value="24">
            </div>
            <div class="form-group">
              <label>文字位置</label>
              <input id="horizontalTextOffset" type="number" value="100" step="5">
            </div>
            <div class="form-group">
              <label>字间距</label>
              <input id="horizontalTextSpacing" type="number" value="1" step="1">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>字体粗细</label>
              <select id="horizontalTextWeight">
                <option value="normal">正常</option>
                <option value="bold" selected>加粗</option>
                <option value="bolder">更粗</option>
                <option value="lighter">更细</option>
              </select>
            </div>
            <div class="form-group">
              <label>字体类型</label>
              <select id="horizontalTextFamily">
                <option value="SimSun" selected>宋体</option>
                <option value="SimHei">黑体</option>
                <option value="KaiTi">楷体</option>
                <option value="FangSong">仿宋</option>
                <option value="Microsoft YaHei">微软雅黑</option>
                <option value="STSong">华文宋体</option>
                <option value="STKaiti">华文楷体</option>
                <option value="PingFang SC">苹方</option>
                <option value="Noto Sans SC">思源黑体</option>
                <option value="Noto Serif SC">思源宋体</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 预览区域 -->
    <div class="preview-panel">
      <div class="preview-card">
        <div class="preview-header">
          <h3>
            实时预览
            <span class="live-preview-badge">自动更新</span>
          </h3>
        </div>
        <div class="canvas-wrapper">
          <canvas id="sealCanvas" width="400" height="400"></canvas>
        </div>
        <div class="effect-buttons">
          <span class="effect-label">做旧效果:</span>
          <button class="btn btn-sm btn-effect" onclick="applyVintageMask()">做旧</button>
          <button class="btn btn-sm btn-effect" onclick="applySoftWornMaskOnSeal()">遮盖</button>
          <button class="btn btn-sm btn-effect" onclick="smear()">拖影</button>
          <button class="btn btn-sm btn-success" onclick="one()">一键做旧</button>
        </div>
        <div class="button-group">
          <button class="btn btn-primary" onclick="drawSeal()">重新生成</button>
          <button class="btn btn-success" onclick="downloadSeal()">下载图片</button>
          <div class="button-divider"></div>
          <button class="btn btn-secondary" onclick="openConfigModal('export')">导出配置</button>
          <button class="btn btn-secondary" onclick="openConfigModal('import')">导入配置</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 配置弹窗 -->
  <div id="configModal" class="modal-overlay">
    <div class="modal">
      <h3 id="modalTitle">配置</h3>
      <textarea id="configText" rows="10"></textarea>
      <div class="modal-buttons">
        <button class="btn btn-secondary" onclick="closeConfigModal()">取消</button>
        <button class="btn btn-primary" id="confirmBtn">确定</button>
      </div>
    </div>
  </div>

  <!-- Toast 提示 -->
  <div id="toast" class="toast"></div>

  <script>
    // Canvas 尺寸配置
    const CANVAS_SIZE = 400;
    let canvasScale = 1;

    // 根据屏幕大小调整 Canvas
    function resizeCanvas() {
      const canvas = document.getElementById("sealCanvas");
      const wrapper = document.querySelector(".canvas-wrapper");
      const wrapperWidth = wrapper.clientWidth - 40; // 减去 padding

      if (window.innerWidth <= 640) {
        const newSize = Math.min(wrapperWidth, CANVAS_SIZE);
        canvasScale = newSize / CANVAS_SIZE;
        canvas.style.width = newSize + "px";
        canvas.style.height = newSize + "px";
      } else {
        canvasScale = 1;
        canvas.style.width = CANVAS_SIZE + "px";
        canvas.style.height = CANVAS_SIZE + "px";
      }
    }

    // 卡片折叠功能
    function toggleCard(header) {
      const card = header.parentElement;
      card.classList.toggle('collapsed');
    }

    // 实时预览：监听所有输入变化
    function setupLivePreview() {
      const inputs = document.querySelectorAll('input, select');
      inputs.forEach(input => {
        input.addEventListener('input', debounce(drawSeal, 100));
        input.addEventListener('change', drawSeal);
      });
    }

    // 防抖函数
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    /**
     * 印章生成器主函数 - 绘制完整的印章图案
     */
    function drawSeal() {
      const canvas = document.getElementById("sealCanvas");
      const ctx = canvas.getContext("2d");

      // 获取用户设置参数
      const sealText = document.getElementById("sealText").value.trim();
      const smallText = document.getElementById("smallText").value.trim();
      const fontSize = parseInt(document.getElementById("fontSize").value);
      const fontWeight = document.getElementById("fontWeight").value;
      const fontFamily = document.getElementById("fontFamily").value;
      const fontColor = document.getElementById("fontColor").value;
      const textRadius = parseInt(document.getElementById("textRadius").value);
      const startDeg = parseFloat(document.getElementById("startDeg").value);
      const endDeg = parseFloat(document.getElementById("endDeg").value);
      const centerChar = document.getElementById("centerChar").value;
      const starSize = parseInt(document.getElementById("starSize").value);
      const circleWidth = parseInt(document.getElementById("circleWidth").value);
      const circleColor = document.getElementById("circleColor").value;
      const enableSmallText = document.getElementById("enableSmallText").checked;
      const enableHorizontalText = document.getElementById("enableHorizontalText").checked;
      const horizontalText = document.getElementById("horizontalText").value.trim();
      const horizontalTextSize = parseInt(document.getElementById("horizontalTextSize").value);
      const horizontalTextOffset = parseInt(document.getElementById("horizontalTextOffset").value);
      const horizontalTextWeight = document.getElementById("horizontalTextWeight").value;
      const horizontalTextFamily = document.getElementById("horizontalTextFamily").value;
      const horizontalTextSpacing = parseInt(document.getElementById("horizontalTextSpacing").value);

      // 计算基本几何参数
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const radius = 160;
      const chars = sealText.split("");
      const textLength = chars.length;

      // 角度计算
      const startAngle = startDeg * Math.PI / 180;
      const endAngle = endDeg * Math.PI / 180;
      const totalAngle = (endAngle + 2 * Math.PI - startAngle) % (2 * Math.PI);
      const angleStep = textLength > 1 ? totalAngle / (textLength - 1) : 0;

      // 清空画布
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // 绘制外圈
      ctx.strokeStyle = circleColor;
      ctx.lineWidth = circleWidth;
      ctx.beginPath();
      ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
      ctx.stroke();

      // 绘制中心图案
      ctx.fillStyle = fontColor;
      ctx.font = `bold ${starSize}px serif`;
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(centerChar, centerX, centerY);

      // 绘制弧形主文字
      ctx.save();
      ctx.translate(centerX, centerY);
      ctx.font = `${fontWeight} ${fontSize}px ${fontFamily}`;
      ctx.fillStyle = fontColor;

      for (let i = 0; i < textLength; i++) {
        const angle = (startAngle + i * angleStep) % (2 * Math.PI);

        const x = textRadius * Math.cos(angle);
        const y = textRadius * Math.sin(angle);

        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(angle + Math.PI / 2);
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(chars[i], 0, 0);
        ctx.restore();
      }

      ctx.restore();

      // 绘制下方弧形小字
      if (enableSmallText) {
        ctx.save();
        ctx.translate(centerX, centerY);
        ctx.font = `bold ${fontSize / 3}px SimSun`;
        ctx.fillStyle = fontColor;

        const bottomChars = smallText.split("");
        const bottomLength = bottomChars.length;
        const totalAngle2 = Math.PI * 0.5;
        const startAngle2 = Math.PI + totalAngle2 + 450;
        const angleStep2 = totalAngle2 / (bottomLength - 1);

        for (let i = 0; i < bottomLength; i++) {
          const angle = startAngle2 - i * angleStep2;
          const x = (textRadius + 20) * Math.cos(angle);
          const y = (textRadius + 20) * Math.sin(angle);

          ctx.save();
          ctx.translate(x, y);
          ctx.rotate(angle + Math.PI / 2);
          ctx.scale(-1, -1);
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.fillText(bottomChars[i], 0, 0);
          ctx.restore();
        }

        ctx.restore();
      }

      // 绘制水平文字
      if (enableHorizontalText && horizontalText) {
        ctx.save();
        ctx.font = `${horizontalTextWeight} ${horizontalTextSize}px ${horizontalTextFamily}`;
        ctx.fillStyle = fontColor;
        ctx.textAlign = "left";
        ctx.textBaseline = "middle";

        const horizontalTextY = centerY + horizontalTextOffset;
        const horizontalChars = horizontalText.split("");
        const charCount = horizontalChars.length;

        let letterSpacing = horizontalTextSpacing;

        if (horizontalTextSpacing === 0 && charCount > 1) {
          ctx.textAlign = "left";
          let totalTextWidth = 0;
          for (let i = 0; i < charCount; i++) {
            totalTextWidth += ctx.measureText(horizontalChars[i]).width;
          }
          letterSpacing = totalTextWidth / (charCount - 1);
        }

        let totalWidth = 0;
        for (let i = 0; i < charCount; i++) {
          totalWidth += ctx.measureText(horizontalChars[i]).width;
          if (i < charCount - 1) totalWidth += letterSpacing;
        }

        let currentX = centerX - totalWidth / 2;
        for (let i = 0; i < charCount; i++) {
          ctx.fillText(horizontalChars[i], currentX, horizontalTextY);
          currentX += ctx.measureText(horizontalChars[i]).width + letterSpacing;
        }

        ctx.restore();
      }
    }

    /**
     * 下载印章图片
     */
    function downloadSeal() {
      const canvas = document.getElementById("sealCanvas");
      const link = document.createElement("a");
      link.download = "seal.png";
      link.href = canvas.toDataURL("image/png");
      link.click();
    }

    /**
     * 印章做旧效果
     */
    function applyVintageMask() {
      const canvas = document.getElementById("sealCanvas");
      const ctx = canvas.getContext("2d");
      let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      let data = imageData.data;

      // 破损遮罩效果
      ctx.save();
      ctx.globalCompositeOperation = "destination-out";
      const maskCount = 20 + Math.floor(Math.random() * 15);

      for (let i = 0; i < maskCount; i++) {
        const x = Math.random() * canvas.width;
        const y = Math.random() * canvas.height;
        const r = Math.random() * 10 + 3;

        const gradient = ctx.createRadialGradient(x, y, 0, x, y, r);
        gradient.addColorStop(0, "rgba(0,0,0,0.4)");
        gradient.addColorStop(1, "rgba(0,0,0,0)");

        ctx.fillStyle = gradient;
        ctx.beginPath();
        ctx.arc(x, y, r, 0, 2 * Math.PI);
        ctx.fill();
      }
      ctx.restore();

      // 噪点效果
      imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      data = imageData.data;

      for (let i = 0; i < data.length; i += 4) {
        if (Math.random() < 0.07) {
          const noise = (Math.random() - 0.5) * 15;
          data[i] = Math.min(255, Math.max(0, data[i] + noise));
          data[i + 1] = Math.min(255, Math.max(0, data[i + 1] + noise));
          data[i + 2] = Math.min(255, Math.max(0, data[i + 2] + noise));
        }
      }
      ctx.putImageData(imageData, 0, 0);

      // 裂痕效果
      imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      data = imageData.data;

      const crackCount = 5 + Math.floor(Math.random() * 5);
      ctx.save();
      ctx.lineCap = "round";
      ctx.shadowColor = 'rgba(150, 0, 0, 0.5)';
      ctx.shadowBlur = 1.5;

      function isSealPixel(x, y) {
        const idx = (y * canvas.width + x) * 4;
        const r = data[idx], g = data[idx + 1], b = data[idx + 2], a = data[idx + 3];
        return a > 50 && r > 100 && g < 100 && b < 100;
      }

      for (let i = 0; i < crackCount; i++) {
        let tries = 0, x, y;
        do {
          x = Math.floor(Math.random() * canvas.width);
          y = Math.floor(Math.random() * canvas.height);
          tries++;
        } while (!isSealPixel(x, y) && tries < 100);

        if (tries >= 100) break;

        const segments = 10 + Math.floor(Math.random() * 8);

        ctx.beginPath();
        ctx.moveTo(x, y);

        for (let j = 0; j < segments; j++) {
          let nx = x + Math.floor((Math.random() - 0.5) * 20);
          let ny = y + Math.floor((Math.random() - 0.5) * 20);

          nx = Math.min(canvas.width - 1, Math.max(0, nx));
          ny = Math.min(canvas.height - 1, Math.max(0, ny));

          if (!isSealPixel(nx, ny)) {
            let found = false;
            for (let dx = -4; dx <= 4; dx++) {
              for (let dy = -4; dy <= 4; dy++) {
                let tx = nx + dx, ty = ny + dy;
                if (tx >= 0 && tx < canvas.width && ty >= 0 && ty < canvas.height) {
                  if (isSealPixel(tx, ty)) {
                    nx = tx;
                    ny = ty;
                    found = true;
                    break;
                  }
                }
              }
              if (found) break;
            }
            if (!found) break;
          }

          ctx.lineTo(nx, ny);
          x = nx;
          y = ny;
        }

        ctx.strokeStyle = `rgba(150, 0, 0, ${0.15 + Math.random() * 0.15})`;
        ctx.lineWidth = 1.5 + Math.random() * 1.5;
        ctx.stroke();
      }
      ctx.restore();

      // 颜色淡化效果
      imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      data = imageData.data;

      for (let y = 0; y < canvas.height; y++) {
        for (let x = 0; x < canvas.width; x++) {
          const idx = (y * canvas.width + x) * 4;
          const r = data[idx];
          const g = data[idx + 1];
          const b = data[idx + 2];
          const a = data[idx + 3];

          const isSealColor = a > 50 && r > 100 && g < 100 && b < 100;
          if (!isSealColor) continue;

          const alpha = 0.1 + Math.random() * 0.3;
          data[idx] = r + (255 - r) * alpha;
          data[idx + 1] = g + (255 - g) * alpha;
          data[idx + 2] = b + (255 - b) * alpha;
        }
      }
      ctx.putImageData(imageData, 0, 0);
    }
    function applySoftWornMaskOnSeal() {
      const canvas = document.getElementById("sealCanvas");
      const ctx = canvas.getContext("2d");

      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;

      // 生成不规则遮盖形状位置（多边形）
      const wornCount = 4 + Math.floor(Math.random() * 6);

      // 先生成遮盖区域多边形数组
      const maskRegions = [];
      for (let i = 0; i < wornCount; i++) {
        const cx = Math.random() * canvas.width;
        const cy = Math.random() * canvas.height;
        const baseRadius = 30 + Math.random() * 40;
        const sides = 6 + Math.floor(Math.random() * 5);
        const points = [];

        for (let j = 0; j < sides; j++) {
          const angle = (Math.PI * 2 / sides) * j + Math.random() * 0.3;
          const radius = baseRadius * (0.7 + Math.random() * 0.6);
          points.push([
            cx + radius * Math.cos(angle),
            cy + radius * Math.sin(angle)
          ]);
        }

        maskRegions.push(points);
      }

      // 判断点是否在多边形内（射线法）
      function pointInPolygon(x, y, polygon) {
        let inside = false;
        for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
          const xi = polygon[i][0], yi = polygon[i][1];
          const xj = polygon[j][0], yj = polygon[j][1];

          const intersect = ((yi > y) != (yj > y))
            && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
          if (intersect) inside = !inside;
        }
        return inside;
      }

      // 对每个像素判断是否属于遮盖区域和印章区域
      for (let y = 0; y < canvas.height; y++) {
        for (let x = 0; x < canvas.width; x++) {
          const idx = (y * canvas.width + x) * 4;

          const r = data[idx];
          const g = data[idx + 1];
          const b = data[idx + 2];
          const a = data[idx + 3];

          // 简单判断印章颜色范围（红色为主，非白色）
          const isSealColor = a > 50 && r > 100 && g < 100 && b < 100;

          if (!isSealColor) continue;

          // 判断是否在遮盖区域
          let inMask = false;
          for (const polygon of maskRegions) {
            if (pointInPolygon(x, y, polygon)) {
              inMask = true;
              break;
            }
          }

          if (inMask) {
            // 半透明白色遮盖 => 让颜色变淡
            const alpha = 0.6 + Math.random() * 0.9; // 透明度随机
            data[idx] = r + (255 - r) * alpha;
            data[idx + 1] = g + (255 - g) * alpha;
            data[idx + 2] = b + (255 - b) * alpha;
          }
        }
      }

      ctx.putImageData(imageData, 0, 0);
    }
    function smear() {
      const canvas = document.getElementById("sealCanvas");
      const ctx = canvas.getContext("2d");
      const w = canvas.width, h = canvas.height;

      const offCanvas = document.createElement("canvas");
      offCanvas.width = w;
      offCanvas.height = h;
      const offCtx = offCanvas.getContext("2d");
      offCtx.drawImage(canvas, 0, 0);

      ctx.clearRect(0, 0, w, h);

      const gridSize = 20;
      const maxRepeat = 4; // 最大拖影层数（增加层数）
      const baseAlpha = 0.35; // 提高基础透明度

      // 为每个格子预先定义拖影因子
      const distortMap = {};
      for (let y = 0; y < h; y += gridSize) {
        for (let x = 0; x < w; x += gridSize) {
          distortMap[`${x},${y}`] = {
            distort: Math.random() < 0.35, // 35% 概率扭曲（增加概率）
            intensity: Math.random() * 0.8 + 0.2,  // 拖影强度因子（0.2~1，避免过弱）
            direction: Math.random() * Math.PI * 2 // 随机拖影方向
          };
        }
      }

      // ✅ 第一步：先绘制原图
      ctx.globalAlpha = 1;
      ctx.drawImage(offCanvas, 0, 0);

      // ✅ 第二步：根据每个格子的拖影强度重复绘制
      for (let repeat = 1; repeat <= maxRepeat; repeat++) {
        for (let y = 0; y < h; y += gridSize) {
          for (let x = 0; x < w; x += gridSize) {
            const cell = distortMap[`${x},${y}`];
            if (!cell) continue;

            const level = cell.intensity; // 拖影强度（影响透明度、偏移）

            // 当前层是否绘制：弱的格子可能不绘制所有层
            if (level < (repeat - 1) / maxRepeat) continue;

            const alpha = baseAlpha * level * (1 - repeat / (maxRepeat + 2));
            ctx.globalAlpha = alpha;

            // 增加偏移量，让拖影更明显（从 ±1 增加到 ±6）
            const offsetDistance = repeat * 1.5 * level;
            const globalOffsetX = Math.cos(cell.direction) * offsetDistance;
            const globalOffsetY = Math.sin(cell.direction) * offsetDistance;

            const doDistort = cell.distort;

            if (doDistort) {
              const offsetX = (Math.random() - 0.5) * 3; // 增加额外偏移
              const offsetY = (Math.random() - 0.5) * 3;
              const scaleX = 1 + (Math.random() - 0.5) * 0.08; // 增加缩放范围
              const scaleY = 1 + (Math.random() - 0.5) * 0.08;
              const angle = (Math.random() - 0.5) * 0.1; // 增加旋转角度

              ctx.save();
              ctx.translate(x + gridSize / 2 + globalOffsetX + offsetX, y + gridSize / 2 + globalOffsetY + offsetY);
              ctx.rotate(angle);
              ctx.scale(scaleX, scaleY);
              ctx.drawImage(offCanvas, x, y, gridSize, gridSize, -gridSize / 2, -gridSize / 2, gridSize, gridSize);
              ctx.restore();
            } else {
              ctx.drawImage(offCanvas, x, y, gridSize, gridSize, x + globalOffsetX, y + globalOffsetY, gridSize, gridSize);
            }
          }
        }
      }

      ctx.globalAlpha = 1;
    }
    //一键
    function one() {
      applyVintageMask();
      applyVintageMask();
      applySoftWornMaskOnSeal();
      smear();
      smear();
    }

    // 页面加载完成后初始化
    window.onload = function () {
      resizeCanvas();
      drawSeal();
      setupLivePreview();

      // 移动端默认折叠部分卡片
      if (window.innerWidth <= 640) {
        const cards = document.querySelectorAll('.card');
        cards.forEach((card, index) => {
          // 保留第一个卡片（基础设置）展开，其他折叠
          if (index > 0) {
            card.classList.add('collapsed');
          }
        });
      }

      // 监听窗口大小变化
      window.addEventListener('resize', debounce(function () {
        resizeCanvas();
      }, 200));
    };

    // 配置导出导入功能
    let currentMode = "";

    function openConfigModal(mode) {
      currentMode = mode;
      const modal = document.getElementById("configModal");
      const textArea = document.getElementById("configText");
      const title = document.getElementById("modalTitle");
      const confirmBtn = document.getElementById("confirmBtn");

      textArea.value = "";

      if (mode === "export") {
        title.textContent = "导出配置";
        confirmBtn.textContent = "复制";
        textArea.value = JSON.stringify(getConfig(), null, 2);
      } else {
        title.textContent = "导入配置";
        confirmBtn.textContent = "导入";
      }

      confirmBtn.onclick = function () {
        if (mode === "export") {
          textArea.select();
          document.execCommand("copy");
          showToast("配置已复制");
        } else {
          try {
            const cfg = JSON.parse(textArea.value);
            setConfig(cfg);
            showToast("配置已导入");
            drawSeal();
          } catch (e) {
            alert("配置格式错误！");
          }
        }
        closeConfigModal();
      };

      modal.style.display = "flex";
    }

    function closeConfigModal() {
      document.getElementById("configModal").style.display = "none";
    }

    function getConfig() {
      return {
        sealText: document.getElementById("sealText").value.trim(),
        smallText: document.getElementById("smallText").value.trim(),
        horizontalText: document.getElementById("horizontalText").value.trim(),
        fontSize: parseInt(document.getElementById("fontSize").value),
        fontWeight: document.getElementById("fontWeight").value,
        fontFamily: document.getElementById("fontFamily").value,
        fontColor: document.getElementById("fontColor").value,
        horizontalTextSize: parseInt(document.getElementById("horizontalTextSize").value),
        horizontalTextWeight: document.getElementById("horizontalTextWeight").value,
        horizontalTextFamily: document.getElementById("horizontalTextFamily").value,
        horizontalTextSpacing: parseInt(document.getElementById("horizontalTextSpacing").value),
        textRadius: parseInt(document.getElementById("textRadius").value),
        startDeg: parseFloat(document.getElementById("startDeg").value),
        endDeg: parseFloat(document.getElementById("endDeg").value),
        horizontalTextOffset: parseInt(document.getElementById("horizontalTextOffset").value),
        centerChar: document.getElementById("centerChar").value,
        starSize: parseInt(document.getElementById("starSize").value),
        circleWidth: parseInt(document.getElementById("circleWidth").value),
        circleColor: document.getElementById("circleColor").value,
        enableSmallText: document.getElementById("enableSmallText").checked,
        enableHorizontalText: document.getElementById("enableHorizontalText").checked
      };
    }

    function setConfig(cfg) {
      document.getElementById("sealText").value = cfg.sealText || "";
      document.getElementById("smallText").value = cfg.smallText || "";
      document.getElementById("horizontalText").value = cfg.horizontalText || "";
      document.getElementById("fontSize").value = cfg.fontSize || 48;
      document.getElementById("fontWeight").value = cfg.fontWeight || "normal";
      document.getElementById("fontFamily").value = cfg.fontFamily || "SimSun";
      document.getElementById("fontColor").value = cfg.fontColor || "#000000";
      document.getElementById("horizontalTextSize").value = cfg.horizontalTextSize || 24;
      document.getElementById("horizontalTextWeight").value = cfg.horizontalTextWeight || "bold";
      document.getElementById("horizontalTextFamily").value = cfg.horizontalTextFamily || "SimSun";
      document.getElementById("horizontalTextSpacing").value = cfg.horizontalTextSpacing || 0;
      document.getElementById("textRadius").value = cfg.textRadius || 120;
      document.getElementById("startDeg").value = cfg.startDeg || 180;
      document.getElementById("endDeg").value = cfg.endDeg || 360;
      document.getElementById("horizontalTextOffset").value = cfg.horizontalTextOffset || 30;
      document.getElementById("centerChar").value = cfg.centerChar || "★";
      document.getElementById("starSize").value = cfg.starSize || 80;
      document.getElementById("circleWidth").value = cfg.circleWidth || 4;
      document.getElementById("circleColor").value = cfg.circleColor || "#000000";
      document.getElementById("enableSmallText").checked = cfg.enableSmallText || false;
      document.getElementById("enableHorizontalText").checked = cfg.enableHorizontalText || false;
    }

    function showToast(message) {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.classList.add("show");
      setTimeout(() => {
        toast.classList.remove("show");
      }, 1500);
    }

  </script>
</body>
</html>